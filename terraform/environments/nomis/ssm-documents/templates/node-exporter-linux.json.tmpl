---
schemaVersion: "2.2"
description: "Installs script exporter on database instance"
mainSteps:
- action: "aws:runShellScript"
  name: "InstallScriptExporter"
  inputs:
    runCommand:
    - "echo 'Downloading Script Exporter tar from GitHub'"
    - "PATH=$PATH:/usr/local/bin # aws binary is sometimes in /usr/local/bin"
    - "wget https://github.com/adhocteam/script_exporter/releases/download/v1.2.0/script_exporter-1.2.0.linux-amd64.tar.gz"
    - "tar -xzf script_exporter-1.2.0.linux-amd64.tar.gz"
    - "rm script_exporter-1.2.0.linux-amd64.tar.gz"
    - "cp node_exporter-1.3.1.linux-amd64/node_exporter /usr/bin/"
    - "rm -rf node_exporter-1.3.1.linux-amd64"
    - "echo 'Downloading node_exporter service script'"
    - "aws s3api get-object --bucket s3-bucket20210929163229537900000001 --key node-exporter/node_exporter_service_linux.sh\
      \ /etc/init.d/node_exporter"
    - "aws s3api get-object --bucket s3-bucket20210929163229537900000001 --key node-exporter/node_exporter_opts\
      \ /tmp/node_exporter"
    - "mv -f /tmp/node_exporter /etc/default/"
    - "chmod 755 /etc/init.d/node_exporter"
    - "killall node_exporter"
    - "echo 'Create Node Exporter Service'"
    - "chkconfig --add node_exporter"
    - "chkconfig --level 3 node_exporter on"
    - "echo 'Start Node Exporter'"
    - "service node_exporter start"